<!DOCTYPE html>

<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>ABCD startup generator</title>

    <style>
        :root {
            --dark_color: #333333;
            --selected_color: #ffe17e;
            --light_color: #a9a9a9;
        }

        body {
            padding: 5px;
            font-family: "Fira Sans", sans-serif;
            font-weight: 400;
            font-size: 12pt;
        }

        h1 {
            font-family: "Fira Sans", sans-serif;
            font-weight: 100;
            font-size: 300%;
        }

        h2 {
            font-family: "Fira Sans", sans-serif;
            font-weight: 200;
            font-size: 250%;
        }

        h3 {
            font-family: "Fira Sans", sans-serif;
            font-weight: 700;
            display: inline-block;
        }

        .display {
            border: 2px dashed var(--light_color);
            border-radius: 5px;
            padding: 15px;
            margin: 15px;
            text-align: left;
            color: var(--dark_color);
        }

        .columns {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            width: 100%;
        }

        .column {
            flex: 1 1 0;
            min-width: 700px;
        }

        .abcd-module {
            cursor: grab;
        }

        .abcd-socket_endpoint {
            cursor: pointer;
        }

        .abcd-socket {
            cursor: pointer;
        }

        .abcd-label {
            font-family: "Fira Sans", sans-serif;
        }

        .abcd-fieldset-selected {
            background-color: var(--selected_color);
        }
    </style>
</head>

<body>

    <h1>ABCD startup generator</h1>
    <div>
        <h2>Warning</h2>
        This generator is not yet usable. TODO:
        <ul>
            <li>Display of socket labels when mouse hovers.</li>
            <li>Adding custom modules for developers.</li>
            <li>Loading the SVG from file and enable the click callbacks on its elements.</li>
        </ul>
    </div>
    <div class="columns">
        <div class="display" class="column">
            <h2>Connections scheme</h2>
            <fieldset>
                <legend>File</legend>
                <button id="button-download_startup_script">Download startup script</button>
                <button id="button-download_SVG">Download SVG</button><br>
                <button id="button-upload_SVG">Upload and Replace SVG</button>
                <label>Select file to upload:
                    <input type="file" id="input-file" accept=".svg" />
                </label>
            </fieldset>
            <fieldset>
                <legend>Modules</legend>
                <button id="button-delete_module">Delete</button>
                <button id="button-new_module">New</button>
                <label for="select-new_module">Select new module:</label>
                <select id="select-new_module">
                </select>
            </fieldset>

            <div id="drawing"></div>
        </div>
        <div class="display" class="column">
            <h2>Global options</h2>
            <div id="global_options">
                <label>Working directory:
                    <input type="text" id="input-working_directory" value="~/abcd_data/" />
                </label>
            </div>
            <h2>Modules options</h2>
            <div id="modules_options"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@svgdotjs/svg.js@latest/dist/svg.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@svgdotjs/svg.draggable.js@latest/dist/svg.draggable.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jszip/dist/jszip.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Colors from the Tableau 10 color palette
            // https://help.tableau.com/current/pro/desktop/en-us/formatting_create_custom_colors.htm
            const color_palettes = {
                white: '#ffffff',
                grey: '#808080',
                black: '#000000',
                tableau: [
                    '#17becf',
                    '#bcbd22',
                    '#7f7f7f',
                    '#e377c2',
                    '#8c564b',
                    '#9467bd',
                    '#d62728',
                    '#2ca02c',
                    '#ff7f0e',
                    '#1f77b4'
                ],
                tableau_medium: [
                    '#6dccda',
                    '#cdcc5d',
                    '#a2a2a2',
                    '#ed97ca',
                    '#a8786e',
                    '#ad8bc9',
                    '#ed665d',
                    '#67bf5c',
                    '#ff9e4a',
                    '#729ece'
                ],
                tableau_light: [
                    '#9edae5',
                    '#dbdb8d',
                    '#c7c7c7',
                    '#f7b6d2',
                    '#c49c94',
                    '#c5b0d5',
                    '#ff9896',
                    '#98df8a',
                    '#ffbb78',
                    '#aec7e8'
                ]
            };

            const settings = {
                unit: 15,
                port_numbers: {
                    min: 16180,
                    max: 65535
                },
                socket_endpoints: {
                    active: color_palettes.white,
                    dimensions: {
                        width: 0.6
                    },
                    commands: {
                        fill: color_palettes.tableau_medium[0],
                        stroke: color_palettes.grey,
                        stroke_width: 1
                    },
                    status: {
                        fill: color_palettes.tableau_medium[1],
                        stroke: color_palettes.grey,
                        stroke_width: 1
                    },
                    data: {
                        fill: color_palettes.tableau_medium[2],
                        stroke: color_palettes.grey,
                        stroke_width: 1
                    },
                    data_spec: {
                        fill: color_palettes.tableau_medium[3],
                        stroke: color_palettes.grey,
                        stroke_width: 1
                    },
                    data_tofcalc: {
                        fill: color_palettes.tableau_medium[4],
                        stroke: color_palettes.grey,
                        stroke_width: 1
                    },
                    data_wadi: {
                        fill: color_palettes.tableau_medium[5],
                        stroke: color_palettes.grey,
                        stroke_width: 1
                    }
                },
                sockets: {
                    dimensions: {
                    },
                    commands: {
                        stroke: color_palettes.tableau[0],
                        stroke_width: 4
                    },
                    status: {
                        stroke: color_palettes.tableau[1],
                        stroke_width: 4
                    },
                    data: {
                        stroke: color_palettes.tableau[2],
                        stroke_width: 4
                    }
                },
                modules: {
                    active: "#ffe17e",
                    dimensions: {
                        width: 7,
                        height: 4,
                        radius: 0.1,
                        label: { x: 1, y: 1 }
                    },
                    abcd: {
                        label: 'abcd',
                        fill: color_palettes.tableau_light[0],
                        stroke: color_palettes.grey,
                        stroke_width: 1,
                        socket_endpoints: [
                            {
                                type: 'commands',
                                direction: 'in',
                                max_connections: 'infinity',
                                label: 'commands',
                                option: '-C',
                                x: 0,
                                y: 3
                            },
                            {
                                type: 'data',
                                direction: 'out',
                                max_connections: 'infinity',
                                label: 'data',
                                option: '-D',
                                x: 7,
                                y: 2
                            },
                            {
                                type: 'status',
                                direction: 'out',
                                max_connections: 'infinity',
                                label: 'status',
                                option: '-S',
                                x: 7,
                                y: 1
                            }
                        ]
                    },
                    wadi: {
                        label: 'wadi',
                        fill: color_palettes.tableau_light[1],
                        stroke: color_palettes.grey,
                        stroke_width: 1,
                        socket_endpoints: [
                            {
                                type: 'data',
                                direction: 'in',
                                max_connections: 1,
                                label: 'data',
                                option: '-A',
                                x: 0,
                                y: 2
                            },
                            {
                                type: 'data_wadi',
                                direction: 'out',
                                max_connections: 'infinity',
                                label: 'data',
                                option: '-D',
                                x: 7,
                                y: 2
                            }
                        ]
                    },
                    waan: {
                        label: 'waan',
                        fill: color_palettes.tableau_light[2],
                        stroke: color_palettes.grey,
                        stroke_width: 1,
                        socket_endpoints: [
                            {
                                type: 'commands',
                                direction: 'in',
                                max_connections: 'infinity',
                                label: 'commands',
                                option: '-C',
                                x: 0,
                                y: 3
                            },
                            {
                                type: 'data',
                                direction: 'in',
                                max_connections: 1,
                                label: 'data',
                                option: '-A',
                                x: 0,
                                y: 2
                            },
                            {
                                type: 'data',
                                direction: 'out',
                                max_connections: 'infinity',
                                label: 'data',
                                option: '-D',
                                x: 7,
                                y: 2
                            },
                            {
                                type: 'status',
                                direction: 'out',
                                max_connections: 'infinity',
                                label: 'status',
                                option: '-S',
                                x: 7,
                                y: 1
                            }
                        ]
                    },
                    dasa: {
                        label: 'dasa',
                        fill: color_palettes.tableau_light[3],
                        stroke: color_palettes.grey,
                        stroke_width: 1,
                        socket_endpoints: [
                            {
                                type: 'commands',
                                direction: 'in',
                                max_connections: 'infinity',
                                label: 'commands',
                                option: '-C',
                                x: 0,
                                y: 3
                            },
                            {
                                type: 'data',
                                direction: 'in',
                                max_connections: 1,
                                label: 'data',
                                option: '-A',
                                x: 0,
                                y: 2
                            },
                            {
                                type: 'status',
                                direction: 'out',
                                max_connections: 'infinity',
                                label: 'status',
                                option: '-S',
                                x: 7,
                                y: 1
                            }
                        ]
                    },
                    spec: {
                        label: 'spec',
                        fill: color_palettes.tableau_light[4],
                        stroke: color_palettes.grey,
                        stroke_width: 1,
                        socket_endpoints: [
                            {
                                type: 'commands',
                                direction: 'in',
                                max_connections: 'infinity',
                                label: 'commands',
                                option: '-C',
                                x: 0,
                                y: 3
                            },
                            {
                                type: 'data',
                                direction: 'in',
                                max_connections: 1,
                                label: 'data',
                                option: '-A',
                                x: 0,
                                y: 2
                            },
                            {
                                type: 'data_spec',
                                direction: 'out',
                                max_connections: 'infinity',
                                label: 'spectrum data',
                                option: '-D',
                                x: 7,
                                y: 2
                            },
                            {
                                type: 'status',
                                direction: 'out',
                                max_connections: 'infinity',
                                label: 'status',
                                option: '-S',
                                x: 7,
                                y: 1
                            }
                        ]
                    },
                    tofcalc: {
                        label: 'tofcalc',
                        fill: color_palettes.tableau_light[5],
                        stroke: color_palettes.grey,
                        stroke_width: 1,
                        socket_endpoints: [
                            {
                                type: 'commands',
                                direction: 'in',
                                max_connections: 'infinity',
                                label: 'commands',
                                option: '-C',
                                x: 0,
                                y: 3
                            },
                            {
                                type: 'data',
                                direction: 'in',
                                max_connections: 1,
                                label: 'data',
                                option: '-A',
                                x: 0,
                                y: 2
                            },
                            {
                                type: 'data_tofcalc',
                                direction: 'out',
                                max_connections: 'infinity',
                                label: 'ToF data',
                                option: '-D',
                                x: 7,
                                y: 2
                            },
                            {
                                type: 'status',
                                direction: 'out',
                                max_connections: 'infinity',
                                label: 'status',
                                option: '-S',
                                x: 7,
                                y: 1
                            }
                        ]
                    },
                    cofi: {
                        label: 'cofi',
                        fill: color_palettes.tableau_light[6],
                        stroke: color_palettes.grey,
                        stroke_width: 1,
                        socket_endpoints: [
                            {
                                type: 'data',
                                direction: 'in',
                                max_connections: 1,
                                label: 'data',
                                option: '-A',
                                x: 0,
                                y: 2
                            },
                            {
                                type: 'data',
                                direction: 'out',
                                max_connections: 'infinity',
                                label: 'coincidence data',
                                option: '-D',
                                x: 7,
                                y: 2
                            },
                            {
                                type: 'data',
                                direction: 'out',
                                max_connections: 'infinity',
                                label: 'anticoincidence data',
                                option: '-N',
                                x: 7,
                                y: 3
                            }
                        ]
                    },
                    filter: {
                        label: 'filter',
                        fill: color_palettes.tableau_light[7],
                        stroke: color_palettes.grey,
                        stroke_width: 1,
                        socket_endpoints: [
                            {
                                type: 'data',
                                direction: 'in',
                                max_connections: 1,
                                label: 'data',
                                option: '-A',
                                x: 0,
                                y: 2
                            },
                            {
                                type: 'data',
                                direction: 'out',
                                max_connections: 'infinity',
                                label: 'data',
                                option: '-D',
                                x: 7,
                                y: 2
                            }
                        ]
                    }
                }
            };

            const drawing = SVG().addTo('#drawing').size('1000px', '1000px');

            const group_sockets = drawing.group();
            group_sockets.attr("id", "abcd-sockets");

            const group_modules = drawing.group();
            group_modules.attr("id", "abcd-modules");
            group_modules.attr("abcd:modules:global_options:working_directory", "~/abcd_data/");

            let module_selected = null;
            let socket_endpoint_selected = null;
            let counter_modules = 0;

            function socket_callback_click() {
                const socket_current = this;
                const from_socket_endpoint = socket_current.attr('abcd:from_socket_endpoint');
                const to_socket_endpoint = socket_current.attr('abcd:to_socket_endpoint');

                console.log(`Selected socket from ${from_socket_endpoint} to ${to_socket_endpoint}`);
                socket_current.remove();
            }

            function create_socket(socket_endpoint_A, socket_endpoint_B) {
                const direction_A = socket_endpoint_A.attr('abcd:socket_endpoint:direction');
                const type = socket_endpoint_A.attr("abcd:socket_endpoint:type");

                let socket_endpoint_from = null;
                let socket_endpoint_to = null;

                if (direction_A === 'out') {
                    socket_endpoint_from = socket_endpoint_A;
                    socket_endpoint_to = socket_endpoint_B;
                } else {
                    socket_endpoint_from = socket_endpoint_B;
                    socket_endpoint_to = socket_endpoint_A;
                }

                const from_id = socket_endpoint_from.attr('id');
                const to_id = socket_endpoint_to.attr('id');

                console.log(`New socket from module ${from_id} to ${to_id}`);

                let socket = group_sockets.line(socket_endpoint_from.cx(), socket_endpoint_from.cy(), socket_endpoint_to.cx(), socket_endpoint_to.cy())
                socket.stroke({ color: settings.sockets[type].stroke, width: settings.sockets[type].stroke_width });

                socket.addClass('abcd-socket')

                socket.attr("abcd:from_socket_endpoint", from_id);
                socket.attr("abcd:to_socket_endpoint", to_id);

                socket.click(socket_callback_click);
            }

            function connections(socket_endpoint) {
                const id = socket_endpoint.attr("id");

                //console.log(`Returning connections of ${id}`)

                return drawing.find('.abcd-socket').reduce(function (connections, socket) {
                    const socket_endpoint_from = socket.attr('abcd:from_socket_endpoint');
                    const socket_endpoint_to = socket.attr('abcd:to_socket_endpoint');
                    
                    if (socket_endpoint_from === id || socket_endpoint_to === id) {
                        connections.push(socket);
                    }

                    return connections;
                }, []);
            }

            function connected_to(socket_endpoint) {
                const id = socket_endpoint.attr("id");

                //console.log(`Checking connections of ${id}`)

                return drawing.find('.abcd-socket').reduce(function (connections, socket) {
                    const socket_endpoint_from = socket.attr('abcd:from_socket_endpoint');
                    const socket_endpoint_to = socket.attr('abcd:to_socket_endpoint');

                    if (socket_endpoint_from === id) {
                        connections.push(SVG(`#${socket_endpoint_to}`).attr("id"));
                    } else if (socket_endpoint_to === id) {
                        connections.push(SVG(`#${socket_endpoint_from}`).attr("id"));
                    }

                    return connections;
                }, []);
            }

            function count_connections(socket_endpoint) {
                const id = socket_endpoint.attr("id");

                //console.log(`Counting connections on ${id}`)

                return drawing.find('.abcd-socket').reduce(function (connections, socket) {
                    const socket_endpoint_from = socket.attr('abcd:from_socket_endpoint');
                    const socket_endpoint_to = socket.attr('abcd:to_socket_endpoint');

                    if (socket_endpoint_from === id || socket_endpoint_to === id) {
                        return connections + 1;
                    } else {
                        return connections;
                    }
                }, 0);
            }

            function too_many_connections(connections, max_connections) {
                if (max_connections === 'infinity') {
                    return false;
                } else {
                    if (connections < max_connections) {
                        return false;
                    } else {
                        return true;
                    }
                }
            }

            function socket_endpoint_callback_click() {
                const socket_endpoint_current = this;

                const id = socket_endpoint_current.attr("id");
                const type = socket_endpoint_current.attr("abcd:socket_endpoint:type");
                const direction = socket_endpoint_current.attr("abcd:socket_endpoint:direction");
                const max_connections = socket_endpoint_current.attr("abcd:socket_endpoint:max_connections");
                const connections = count_connections(socket_endpoint_current);

                if (socket_endpoint_selected === socket_endpoint_current) {
                    console.log(`Deselecting: ${id}`);

                    socket_endpoint_current.fill(settings.socket_endpoints[type].fill);
                    socket_endpoint_selected = null;
                } else if (socket_endpoint_selected) {
                    const other_id = socket_endpoint_selected.attr("id");
                    const other_type = socket_endpoint_selected.attr("abcd:socket_endpoint:type");
                    const other_direction = socket_endpoint_selected.attr("abcd:socket_endpoint:direction");
                    const other_max_connections = socket_endpoint_selected.attr("abcd:socket_endpoint:max_connections");
                    const other_connections = count_connections(socket_endpoint_selected);

                    if (type !== other_type) {
                        console.error(`Types do not match: ${type} and ${other_type}`);
                    } else if (direction === other_direction) {
                        console.error(`Directions are not compatible: ${direction} and ${other_direction}`);
                    } else if (too_many_connections(connections, max_connections)) {
                        console.error(`Too many connections on ${id}: ${connections}; max: ${max_connections}`);
                    } else if (too_many_connections(other_connections, other_max_connections)) {
                        console.error(`Too many connections on ${other_id}: ${other_connections}; max: ${other_max_connections}`);
                    } else {
                        create_socket(socket_endpoint_current, socket_endpoint_selected);

                        socket_endpoint_selected.fill(settings.socket_endpoints[type].fill);
                        socket_endpoint_selected = null;
                    }
                } else {
                    console.log(`Selected: ${id}`);

                    socket_endpoint_current.fill(settings.socket_endpoints.active);
                    socket_endpoint_selected = socket_endpoint_current;
                }
            }

            function create_socket_endpoint(id, these_settings) {
                const x = these_settings.x * settings.unit;
                const y = these_settings.y * settings.unit;
                const w = settings.socket_endpoints.dimensions.width * settings.unit;

                let socket_endpoint = null;

                if (these_settings.type === 'commands') {
                    socket_endpoint = SVG().rect(w, w);
                    socket_endpoint.move(x - w / 2, y - w / 2);
                } else if (these_settings.type === 'status') {
                    socket_endpoint = SVG().circle(w);
                    socket_endpoint.move(x - w / 2, y - w / 2);
                } else if (these_settings.type === 'data') {
                    const x_center = w * Math.sqrt(2) / 2;
                    const x_right = w * Math.sqrt(2);
                    const y_center = w * Math.sqrt(2) / 2;
                    const y_bottom = w * Math.sqrt(2);

                    socket_endpoint = SVG().polygon(`${x_center},0 0,${y_center} ${x_center},${y_bottom} ${x_right},${y_center}`);
                    socket_endpoint.move(x - x_center, y - y_center);
                } else {
                    const x_right = w * Math.sqrt(3) / 2;
                    const y_center = w / 2;
                    const y_bottom = w;

                    socket_endpoint = SVG().polygon(`0,0 0,${y_bottom} ${x_right},${y_center}`);
                    socket_endpoint.move(x - x_right / 2, y - y_bottom / 2);
                }

                socket_endpoint.fill(settings.socket_endpoints[these_settings.type].fill);
                socket_endpoint.stroke({ color: settings.socket_endpoints[these_settings.type].stroke, width: settings.socket_endpoints[these_settings.type].stroke_width });

                socket_endpoint.attr("id", id);
                socket_endpoint.attr("abcd:socket_endpoint:type", these_settings.type);
                socket_endpoint.attr("abcd:socket_endpoint:direction", these_settings.direction);
                socket_endpoint.attr("abcd:socket_endpoint:max_connections", these_settings.max_connections);
                socket_endpoint.attr("abcd:socket_endpoint:option", these_settings.option);

                socket_endpoint.addClass('abcd-socket_endpoint')

                socket_endpoint.click(socket_endpoint_callback_click);

                return socket_endpoint;
            }

            function module_callback_dragmove(event) {
                //eevent.preventDefault();
                drawing.find('.abcd-socket').forEach(function (socket) {
                    const socket_endpoint_from = socket.attr('abcd:from_socket_endpoint');
                    const socket_endpoint_to = socket.attr('abcd:to_socket_endpoint');

                    //console.log(`Seleted line from socket_endpoint ${from_socket_endpoint} to ${to_socket_endpoint}`);

                    const element_from = SVG(`#${socket_endpoint_from}`);
                    const element_to = SVG(`#${socket_endpoint_to}`);

                    socket.attr('x1', element_from.cx());
                    socket.attr('x2', element_to.cx());
                    socket.attr('y1', element_from.cy());
                    socket.attr('y2', element_to.cy());
                });
            }

            function create_module_fieldset(id, module_id, executable, display_label, options) {
                const div = document.getElementById("modules_options");

                const fieldset = document.createElement("fieldset");
                fieldset.id = id;
                fieldset.setAttribute("abcd:module", module_id);
                div.appendChild(fieldset);

                const legend = document.createElement("legend");
                legend.textContent = display_label;
                fieldset.appendChild(legend);

                const label_executable = document.createElement("label");
                label_executable.textContent = "Executable:";
                fieldset.appendChild(label_executable);

                const input_executable = document.createElement("input");
                input_executable.id = `${id}-input-executable`;
                input_executable.type = "text";
                input_executable.value = executable;
                input_executable.addEventListener("input", update_modules_attributes);
                label_executable.appendChild(input_executable);

                fieldset.appendChild(document.createElement("br"));

                const label_display_label = document.createElement("label");
                label_display_label.textContent = "Display label:";
                fieldset.appendChild(label_display_label);

                const input_display_label = document.createElement("input");
                input_display_label.id = `${id}-input-display_label`;
                input_display_label.type = "text";
                input_display_label.value = display_label;
                input_display_label.addEventListener("input", () => {
                    console.log("Display label changed:", input_display_label.value)
                    legend.textContent = input_display_label.value;

                    update_modules_attributes();
                });
                label_display_label.appendChild(input_display_label);

                fieldset.appendChild(document.createElement("br"));

                const label_options = document.createElement("label");
                label_options.textContent = "Options:";
                fieldset.appendChild(label_options);

                const input_options = document.createElement("input");
                input_options.id = `${id}-input-options`;
                input_options.type = "text";
                input_options.value = options;
                input_options.style.width = "100%";
                input_options.addEventListener("input", update_modules_attributes);
                label_options.appendChild(input_options);
            }

            function find_fieldset(module_id) {
                return Array.from(document.querySelectorAll(`fieldset[abcd\\:module="${module_id}"]`)).reduce((_, current) => current, null);
            }

            function module_callback_click() {
                const rectangle_current = this;
                const module_current = rectangle_current.parent();
                const id = module_current.attr("id");
                const type = module_current.attr("abcd:module:type");

                const rectangle = module_current.find("rect").reduce((selected, current) => current.hasClass("abcd-module-rectangle") ? current : selected, null);

                if (module_selected === module_current) {
                    console.log(`Deselecting: ${id}`);

                    rectangle.fill(settings.modules[type].fill);
                    const fieldset = find_fieldset(id);
                    fieldset.classList.remove("abcd-fieldset-selected");
                    module_selected = null;
                } else if (module_selected) {
                    const other_id = module_selected.attr("id");
                    const other_type = module_selected.attr("abcd:module:type");

                    const other_rectangle = module_selected.find("rect").reduce((selected, current) => current.hasClass("abcd-module-rectangle") ? current : selected, null);

                    console.log(`Deselecting: ${other_id} and selecting: ${id}`);
                    other_rectangle.fill(settings.modules[other_type].fill);
                    rectangle.fill(settings.modules.active);
                    module_selected = module_current;

                    const other_fieldset = find_fieldset(other_id);
                    other_fieldset.classList.remove("abcd-fieldset-selected");
                    const fieldset = find_fieldset(id);
                    fieldset.classList.add("abcd-fieldset-selected");
                } else {
                    console.log(`Selected: ${id}`);

                    rectangle.fill(settings.modules.active);
                    const fieldset = find_fieldset(id);
                    fieldset.classList.add("abcd-fieldset-selected");
                    module_selected = module_current;
                }
            }

            function create_module(id, type, executable, display_label, options, x, y) {
                console.log(`New module of type: ${type}, id: ${id}`);

                const module = group_modules.group();
                module.draggable();

                module.attr("id", id);
                module.addClass('abcd-module');

                module.attr("abcd:module:type", type);
                module.attr("abcd:module:executable", executable);
                module.attr("abcd:module:display_label", display_label);
                module.attr("abcd:module:options", options);

                const rectangle = module.rect(settings.modules.dimensions.width * settings.unit, settings.modules.dimensions.height * settings.unit).radius(settings.modules.dimensions.radius * settings.unit);
                rectangle.addClass('abcd-module-rectangle');

                rectangle.fill(settings.modules[type].fill)
                rectangle.stroke({ color: settings.modules[type].stroke, width: settings.modules[type].stroke_width });

                rectangle.click(module_callback_click);

                settings.modules[type].socket_endpoints.forEach((socket_endpoint, index, a) =>
                    create_socket_endpoint(`${id}-socket_${index}`, socket_endpoint).addTo(module)
                );

                const label = module.plain(settings.modules[type].label)
                label.addClass('abcd-label');
                label.move(settings.modules.dimensions.label.x * settings.unit, settings.modules.dimensions.label.y * settings.unit);

                module.move(x, y);

                module.on('dragmove', module_callback_dragmove);

                create_module_fieldset(`abcd-fieldset-${id}`, id, executable, display_label, options);

                return module;
            }

            function generate_startup_script(drawing) {
                update_working_directory();
                update_modules_attributes();

                const socket_endpoints_connections = drawing.find('.abcd-socket_endpoint').reduce((socket_endpoints_connections, socket_endpoint) => {
                    socket_endpoints_connections[socket_endpoint.attr("id")] = connected_to(socket_endpoint);
                    return socket_endpoints_connections;
                }, {});

                let port_numbers = {};

                let port_number_next = settings.port_numbers.min;

                for (const [socket_endpoint_id, connections] of Object.entries(socket_endpoints_connections)) {
                    //const new_port_number = Math.floor(Math.random() * (settings.port_numbers.max - settings.port_numbers.min) + settings.port_numbers.min);
                    const port_number_new = port_number_next;

                    if (!port_numbers.hasOwnProperty(socket_endpoint_id)) {
                        port_numbers[socket_endpoint_id] = port_number_new;
                    }
                    for (const other_socket_endpoint_id of connections) {
                        if (!port_numbers.hasOwnProperty(other_socket_endpoint_id)) {
                            port_numbers[other_socket_endpoint_id] = port_number_new;
                        }
                    }

                    port_number_next = port_number_new + 1;
                }

                const modules = drawing.find('.abcd-module').map((module) => ({
                    id: module.attr("id"),
                    type: module.attr("abcd:module:type"),
                    executable: module.attr("abcd:module:executable"),
                    display_label: module.attr("abcd:module:display_label"),
                    options: module.attr("abcd:module:options"),
                    socket_endpoints: module.find(".abcd-socket_endpoint").map((socket_endpoint) => ({
                        id: socket_endpoint.attr("id"),
                        type: socket_endpoint.attr("abcd:socket_endpoint:type"),
                        option: socket_endpoint.attr("abcd:socket_endpoint:option"),
                        direction: socket_endpoint.attr("abcd:socket_endpoint:direction"),
                        port: port_numbers[socket_endpoint.attr("id")]
                    }))
                }));

                const working_directory_raw = document.getElementById('input-working_directory').value;
                const working_directory_clean = working_directory_raw.endsWith('/') ? working_directory_raw : working_directory_raw + '/';

                let script_content = '#! /bin/bash\n';
                script_content += '\n';

                script_content += 'WORKING_DIRECTORY="$(readlink -f "' + String(working_directory_raw) + '")"\n';
                script_content += 'echo "Working directory: ${WORKING_DIRECTORY}"\n';
                script_content += 'echo "Creating directory for the user: ${WORKING_DIRECTORY}"\n';
                script_content += 'mkdir -p "${WORKING_DIRECTORY}"\n';
                script_content += 'mkdir -p "${WORKING_DIRECTORY}/configs"\n';
                script_content += 'echo "Changing current directory to: ${WORKING_DIRECTORY}"\n';
                script_content += 'cd "${WORKING_DIRECTORY}"\n';
                script_content += '\n';

                script_content += 'echo "Unsetting TMUX in order to be able to launch new sessions from tmux"\n';
                script_content += 'unset TMUX\n';
                script_content += '\n';
                script_content += 'echo "Starting a new ABCD session"\n';
                script_content += 'tmux new-session -d -s ABCD\n';
                script_content += '\n';
                script_content += 'echo "Creating the window for the GUI webserver"\n';
                script_content += 'tmux new-window -d -c "/opt/local/abcd/wit/" -P -t ABCD -n wit "node app.js ./config.json"\n';
                script_content += 'echo "Waiting for node.js to start"\n';
                script_content += 'sleep 2\n';
                script_content += '\n';

                modules.forEach((module, index) => {
                    script_content += `echo "Creating the window for ${module.display_label} of type ${module.type}"\n`;
                    script_content += `tmux new-window -d -c "\${WORKING_DIRECTORY}" -P -t ABCD -n ${module.type}_${index} '${module.executable}`
                    for (const socket_endpoint of module.socket_endpoints) {
                        const ip_address = socket_endpoint.direction === 'in' ? '127.0.0.1' : '*';
                        script_content += ` ${socket_endpoint.option} tcp://${ip_address}:${socket_endpoint.port}`;
                    }
                    script_content += ` ${module.options}'\n`

                    index += 1;
                });

                return script_content;
            }

            function update_working_directory() {
                const working_directory_raw = document.getElementById('input-working_directory').value;
                const working_directory_clean = working_directory_raw.endsWith('/') ? working_directory_raw : working_directory_raw + '/';

                group_modules.attr("abcd:modules:global_options:working_directory", working_directory_clean);
            }

            function update_modules_attributes() {
                const select_new_module = document.getElementById('select-new_module');

                Object.entries(settings.modules)
                    .filter(([type, module_settings]) => (type !== "active" && type !== "dimensions"))
                    .forEach(([type, module_settings]) => {
                        const option = document.createElement('option');
                        option.text = type;
                        option.value = type;
                        select_new_module.add(option);
                    });

                drawing.find('.abcd-module').forEach((module) => {
                    const id = module.attr("id");

                    //console.log(`Updating attributes of module: ${id}`)

                    const fieldset = find_fieldset(id);
                    const executable = fieldset.querySelectorAll('[id$="-input-executable"]')[0].value;
                    const display_label = fieldset.querySelectorAll('[id$="-input-display_label"]')[0].value;
                    const options = fieldset.querySelectorAll('[id$="-input-options"]')[0].value;

                    module.attr("abcd:module:executable", executable);
                    module.attr("abcd:module:display_label", display_label);
                    module.attr("abcd:module:options", options);
                });
            }

            document.getElementById('button-download_startup_script').addEventListener('click', function () {
                const script_content = generate_startup_script(drawing);
                const blob_script = new Blob([script_content], { type: "text/plain" });
                const URL_script = URL.createObjectURL(blob_script);
                const anchor = document.createElement("a");
                anchor.href = URL_script;
                anchor.download = "ABCD_startup.sh";
                document.body.appendChild(anchor);
                anchor.click();
                document.body.removeChild(anchor);
            });

            document.getElementById('button-download_SVG').addEventListener('click', function () {
                const SVG_content = drawing.svg();
                const blob_SVG = new Blob([SVG_content], { type: "image/svg+xml;charset=utf-8" });
                const URL_SVG = URL.createObjectURL(blob_SVG);
                const anchor = document.createElement("a");
                anchor.href = URL_SVG;
                anchor.download = "ABCD_startup.svg";
                document.body.appendChild(anchor);
                anchor.click();
                document.body.removeChild(anchor);
            });

            document.getElementById('button-upload_SVG').addEventListener('click', function () {
                const input_file = document.getElementById('input-file');
                if (input_file.files.length > 0) {
                    const reader = new FileReader();

                    reader.onload = function (event) {
                        const new_SVG_content = event.target.result;
                        drawing.clear();
                        drawing.svg(new_SVG_content);
                        // TODO: Re-initialize draggable elements and other interactive features if necessary
                    };

                    reader.readAsText(input_file.files[0]);
                } else {
                    alert('Please select an SVG file to upload.');
                }
            });

            document.getElementById('button-new_module').addEventListener('click', function () {
                const select_new_module = document.getElementById('select-new_module');
                const new_module_type = select_new_module.value;

                create_module(`abcd-module_${counter_modules}`, new_module_type, new_module_type, '', "", 0.2 * settings.modules.dimensions.width * settings.unit, 0.2 * settings.modules.dimensions.height * settings.unit);
                counter_modules += 1;
            });

            document.getElementById('button-delete_module').addEventListener('click', function () {
                if (module_selected) {
                    const module_id = module_selected.attr("id");

                    module_selected.find('.abcd-socket_endpoint').forEach(socket_endpoint => {
                        connections(socket_endpoint).forEach(socket => {
                            socket.remove();
                        });

                    });

                    module_selected.remove()
                    module_selected = null;

                    find_fieldset(module_id).remove();
                }
            });

            document.getElementById('input-working_directory').addEventListener('input', update_working_directory);

            // Creating the default set of modules
            create_module(`abcd-module_${counter_modules}`, 'abcd', 'abcd', 'digitizer_interface', "-v -T 50 -f ./configs/abcd_config.json", 0.5 * settings.modules.dimensions.width * settings.unit, 2.0 * settings.modules.dimensions.height * settings.unit);
            counter_modules += 1;
            create_module(`abcd-module_${counter_modules}`, 'waan', 'waan', 'waveforms_analysis', "-v -T 50 -f ./configs/waan_config.json", 2.0 * settings.modules.dimensions.width * settings.unit, 2.0 * settings.modules.dimensions.height * settings.unit);
            counter_modules += 1;
            create_module(`abcd-module_${counter_modules}`, 'wadi', 'wadi', 'waveforms_display', "", 3.5 * settings.modules.dimensions.width * settings.unit, 0.5 * settings.modules.dimensions.height * settings.unit);
            counter_modules += 1;
            create_module(`abcd-module_${counter_modules}`, 'dasa', 'dasa', 'data_saver', "", 3.5 * settings.modules.dimensions.width * settings.unit, 2.0 * settings.modules.dimensions.height * settings.unit);
            counter_modules += 1;
            create_module(`abcd-module_${counter_modules}`, 'spec', 'spec', 'spectrum_calculator', "", 3.5 * settings.modules.dimensions.width * settings.unit, 3.5 * settings.modules.dimensions.height * settings.unit);
            counter_modules += 1;
            create_module(`abcd-module_${counter_modules}`, 'tofcalc', 'tofcalc', 'ToF_calculator', "-f ./configs/tofcalc_config.json", 3.5 * settings.modules.dimensions.width * settings.unit, 5.0 * settings.modules.dimensions.height * settings.unit);
            counter_modules += 1;
            //create_module(`abcd-module_${counter_modules}`, 'cofi', 'cofi', 'coincidences', "-n 0.001953125 -w 100", 5.0 * settings.modules.dimensions.width * settings.unit, 0.5 * settings.modules.dimensions.height * settings.unit);
            //counter_modules += 1;
            //create_module(`abcd-module_${counter_modules}`, 'filter', 'filter', 'generic_filter', "-v", 5.0 * settings.modules.dimensions.width * settings.unit, 2.0 * settings.modules.dimensions.height * settings.unit);
            //counter_modules += 1;

            create_socket(SVG('#abcd-module_0-socket_1'), SVG('#abcd-module_1-socket_1'));
            create_socket(SVG('#abcd-module_1-socket_2'), SVG('#abcd-module_2-socket_0'));
            create_socket(SVG('#abcd-module_1-socket_2'), SVG('#abcd-module_3-socket_1'));
            create_socket(SVG('#abcd-module_1-socket_2'), SVG('#abcd-module_4-socket_1'));
            create_socket(SVG('#abcd-module_1-socket_2'), SVG('#abcd-module_5-socket_1'));

            // Forcing an update of the attributes.
            // If the user modified attributes and then refreshed the page it
            // would not trigger the event listeners and thus it would not
            // update the attributes.
            update_working_directory();
            update_modules_attributes();
        });
    </script>
</body>

</html>