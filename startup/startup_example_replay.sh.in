#! /bin/bash
#
# Example of startup script for a replay

TODAY="$(date "+%Y%m%d")"

# Check if the DATA_DIRECTORY variable is set in the environment
# The DATA_DIRECTORY indicates where the data should be saved
if [[ -z "${DATA_DIRECTORY}" ]]; then
    DATA_DIRECTORY="${PWD}/abcd_data_${TODAY}/"
    mkdir -p "${DATA_DIRECTORY}"
fi

# The user may provide the file name to replay as an argument to this script
# Otherwise it will use the standard example data
if [[ -z "$1" ]]
then
    FILE_NAME="@ABCD_FULL_DATADIR@/data/example_data_DT5730_Ch1_LaBr3_Ch6_CeBr3_Ch7_CeBr3_coincidence_raw.adr.bz2"
else
    FILE_NAME="$1"
fi

# Unsetting $TMUX in order to be able to launch new sessions from tmux
unset TMUX

if command -v waan &> /dev/null
then
    printf '\e[1m\e[31mERROR:\e[0m cannot find waan. \e[1m\e[32mSuggestion:\e[0m Was ABCD correctly installed?\n'
    return 1
fi

# Checking if another ABCD session is running
if [ "`tmux ls 2> /dev/null | grep ABCD | wc -l`" -gt 0 ]
then
    echo "Kiling previous ABCD sessions"
    tmux kill-session -t ABCD
    sleep 2
fi

echo "Starting a new ABCD session"
tmux new-session -d -s ABCD

echo "Creating the window for the GUI webserver: WebInterfaceTwo"
tmux new-window -d -P -t ABCD -n wit 'wit.sh'

echo "Creating logger window"
mkdir -p "${DATA_DIRECTORY}/log"
tmux new-window -d -P -t ABCD -n logger "log_status_events.py -v -o ${DATA_DIRECTORY}/log/ABCD_status_events_${TODAY}.tsv -S 'tcp://127.0.0.1:16180' 'tcp://127.0.0.1:16185' 'tcp://127.0.0.1:16206'"

echo "Waiting for node.js to start"
sleep 2

echo "Creating replayer window, replaying file: ${FILE_NAME}"
tmux new-window -d -P -t ABCD -n replay "replay_raw.py -c -D 'tcp://*:16207' -T 100 ${FILE_NAME}"

echo "Creating WaAn window"
tmux new-window -d -P -t ABCD -n waan 'waan -v -T 100 -A tcp://127.0.0.1:16207 -D tcp://*:16181 -f @ABCD_FULL_DATADIR@/waan/config_example_data.json'

echo "Creating DaSa window, directory: ${DATA_DIRECTORY}"
tmux new-window -d -c "${DATA_DIRECTORY}" -P -t ABCD -n dasa "dasa -v"

echo "Creating WaDi windows"
tmux new-window -d -P -t ABCD -n wadidigi 'wadi -v -A tcp://127.0.0.1:16207'
tmux new-window -d -P -t ABCD -n wadiwaan 'wadi -v -A tcp://127.0.0.1:16181 -D tcp://*:17190'

echo "Creating tofcalc window"
tmux new-window -d -P -t ABCD -n tofcalc "tofcalc -f @ABCD_FULL_DATADIR@/tofcalc/DT5730_LaBr_CeBr.json"

echo "Creating spec window"
tmux new-window -d -P -t ABCD -n spec "spec"

echo "System started!"
echo "Connect to GUI on addresses: http://127.0.0.1:8080/"